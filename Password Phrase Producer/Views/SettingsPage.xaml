<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Password_Phrase_Producer.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:Password_Phrase_Producer.Converters"
    xmlns:viewmodels="clr-namespace:Password_Phrase_Producer.ViewModels"
    Padding="0"
    Shell.NavBarIsVisible="False">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:StringNotNullOrWhiteSpaceConverter x:Key="StringNotNullOrWhiteSpaceConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.Background>
        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#101018" Offset="0" />
            <GradientStop Color="#141426" Offset="0.6" />
            <GradientStop Color="#0F111A" Offset="1" />
        </LinearGradientBrush>
    </ContentPage.Background>

    <Grid RowDefinitions="Auto,*">
        <!-- Header -->
        <Grid
            Padding="16,16,16,10"
            ColumnDefinitions="Auto,*,Auto"
            ColumnSpacing="10">
            
            <!-- Hamburger Menu -->
            <Border
                WidthRequest="34"
                HeightRequest="34"
                BackgroundColor="#1F2338"
                StrokeThickness="0"
                VerticalOptions="Center">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="#25000000" Radius="6" Offset="0,3" />
                </Border.Shadow>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnOpenFlyoutTapped" />
                </Border.GestureRecognizers>
                <Image
                    Source="menu.png"
                    WidthRequest="18"
                    HeightRequest="18"
                    HorizontalOptions="Center"
                    VerticalOptions="Center" />
            </Border>

            <Label 
                Grid.Column="1"
                Text="Einstellungen"
                FontSize="18"
                FontAttributes="Bold"
                TextColor="White"
                VerticalOptions="Center" />

            <!-- Back Button -->
            <Border
                Grid.Column="2"
                WidthRequest="34"
                HeightRequest="34"
                BackgroundColor="#1F2338"
                StrokeThickness="0"
                HorizontalOptions="End"
                VerticalOptions="Center">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="#25000000" Radius="6" Offset="0,3" />
                </Border.Shadow>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnBackTapped" />
                </Border.GestureRecognizers>
                <Image
                    Source="chevronright.png"
                    WidthRequest="18"
                    HeightRequest="18"
                    HorizontalOptions="Center"
                    VerticalOptions="Center"
                    Rotation="0" />
            </Border>
        </Grid>

        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="16,0,16,24" Spacing="16">
                <Border
                    BackgroundColor="#1B2036"
                    Padding="14"
                    StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="16" />
                    </Border.StrokeShape>
                    <Border.Shadow>
                        <Shadow Brush="#25000000" Radius="12" Offset="0,6" />
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="10">
                        <Label
                            Text="Datensicherung"
                            FontSize="16"
                            FontAttributes="Bold"
                            TextColor="White" />
                        <Label
                            Text="Exportiere verschlüsselte Tresordaten oder Backups und importiere vorhandene Dateien."
                            FontSize="12"
                            TextColor="#9EA3C4" />
                        <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,*" ColumnSpacing="10" RowSpacing="10">
                            <Button
                                Text="Backup exportieren"
                                Clicked="OnExportBackupClicked"
                                BackgroundColor="#4A5CFF"
                                TextColor="White"
                                FontSize="11"
                                Padding="8,6"
                                CornerRadius="10" />
                            <Button
                                Grid.Column="1"
                                Text="Backup importieren"
                                Clicked="OnImportBackupClicked"
                                BackgroundColor="#1F2338"
                                TextColor="White"
                                FontSize="11"
                                Padding="8,6"
                                CornerRadius="10" />
                            <Button
                                Grid.Row="1"
                                Text="Tresor exportieren"
                                Clicked="OnExportEncryptedClicked"
                                BackgroundColor="#4A5CFF"
                                TextColor="White"
                                FontSize="11"
                                Padding="8,6"
                                CornerRadius="10" />
                            <Button
                                Grid.Row="1"
                                Grid.Column="1"
                                Text="Tresor importieren"
                                Clicked="OnImportEncryptedClicked"
                                BackgroundColor="#1F2338"
                                TextColor="White"
                                FontSize="11"
                                Padding="8,6"
                                CornerRadius="10" />
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <Border
                    BackgroundColor="#1B2036"
                    Padding="14"
                    StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="16" />
                    </Border.StrokeShape>
                    <Border.Shadow>
                        <Shadow Brush="#25000000" Radius="12" Offset="0,6" />
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="10">
                        <Label
                            Text="Master-Passwort"
                            FontSize="16"
                            FontAttributes="Bold"
                            TextColor="White" />
                        <Label
                            Text="Der Tresor muss entsperrt sein, um das Passwort zu ändern."
                            TextColor="#9EA3C4"
                            FontSize="12">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding IsVaultUnlocked}" Value="True">
                                    <Setter Property="IsVisible" Value="False" />
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>

                        <Entry
                            Text="{Binding NewMasterPassword}"
                            Placeholder="Neues Master-Passwort"
                            PlaceholderColor="#7F85B2"
                            TextColor="White"
                            BackgroundColor="#1F2338"
                            IsPassword="True"
                            IsEnabled="{Binding IsVaultUnlocked}"
                            FontSize="13"
                            HeightRequest="38" />
                        <Entry
                            Text="{Binding ConfirmMasterPassword}"
                            Placeholder="Passwort bestätigen"
                            PlaceholderColor="#7F85B2"
                            TextColor="White"
                            BackgroundColor="#1F2338"
                            IsPassword="True"
                            IsEnabled="{Binding IsVaultUnlocked}"
                            FontSize="13"
                            HeightRequest="38" />

                        <Grid ColumnDefinitions="Auto,*" IsVisible="{Binding CanUseBiometric}">
                            <Switch
                                Grid.Column="0"
                                IsToggled="{Binding EnableBiometric}"
                                IsEnabled="{Binding IsVaultUnlocked}" />
                            <Label
                                Grid.Column="1"
                                Text="Biometrische Anmeldung speichern"
                                FontSize="11"
                                TextColor="#E8EBFF"
                                Margin="10,0,0,0"
                                VerticalOptions="Center"
                                LineBreakMode="WordWrap" />
                        </Grid>

                        <Label
                            Text="{Binding ChangePasswordError}"
                            TextColor="#FF7474"
                            FontSize="11"
                            IsVisible="{Binding ChangePasswordError, Converter={StaticResource StringNotNullOrWhiteSpaceConverter}}" />
                        <Label
                            Text="{Binding ChangePasswordSuccess}"
                            TextColor="#63F5A8"
                            FontSize="11"
                            IsVisible="{Binding ChangePasswordSuccess, Converter={StaticResource StringNotNullOrWhiteSpaceConverter}}" />

                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12" VerticalOptions="Center">
                            <Button
                                Text="Passwort aktualisieren"
                                Command="{Binding ChangePasswordCommand}"
                                BackgroundColor="#4A5CFF"
                                TextColor="White"
                                FontSize="13"
                                CornerRadius="12"
                                Padding="12,8" />
                            <ActivityIndicator
                                Grid.Column="1"
                                IsRunning="{Binding IsPasswordChangeBusy}"
                                IsVisible="{Binding IsPasswordChangeBusy}"
                                Color="#63F5A8"
                                WidthRequest="24"
                                HeightRequest="24" />
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <Border
                    BackgroundColor="#1B2036"
                    Padding="14"
                    StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="16" />
                    </Border.StrokeShape>
                    <Border.Shadow>
                        <Shadow Brush="#25000000" Radius="12" Offset="0,6" />
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="10">
                        <Label
                            Text="Authenticator-Passwort"
                            FontSize="16"
                            FontAttributes="Bold"
                            TextColor="White" />

                        <Label
                            Text="Schützt deine 2FA-Codes. Du kannst hier ein Passwort setzen oder ändern."
                            TextColor="#9EA3C4"
                            FontSize="12" />

                        <Label
                            Text="Aktuelles Authenticator-Passwort"
                            TextColor="#9EA3C4"
                            FontSize="12">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding HasAuthenticatorPassword}" Value="False">
                                    <Setter Property="IsVisible" Value="False" />
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>
                        <Entry
                            Text="{Binding CurrentAuthenticatorPassword}"
                            Placeholder="Aktuelles Passwort"
                            PlaceholderColor="#7F85B2"
                            TextColor="White"
                            BackgroundColor="#1F2338"
                            IsPassword="True"
                            FontSize="13"
                            HeightRequest="38">
                            <Entry.Triggers>
                                <DataTrigger TargetType="Entry" Binding="{Binding HasAuthenticatorPassword}" Value="False">
                                    <Setter Property="IsVisible" Value="False" />
                                </DataTrigger>
                            </Entry.Triggers>
                        </Entry>

                        <Entry
                            Text="{Binding NewAuthenticatorPassword}"
                            Placeholder="Neues Authenticator-Passwort"
                            PlaceholderColor="#7F85B2"
                            TextColor="White"
                            BackgroundColor="#1F2338"
                            IsPassword="True"
                            FontSize="13"
                            HeightRequest="38" />
                        <Entry
                            Text="{Binding ConfirmAuthenticatorPassword}"
                            Placeholder="Passwort bestätigen"
                            PlaceholderColor="#7F85B2"
                            TextColor="White"
                            BackgroundColor="#1F2338"
                            IsPassword="True"
                            FontSize="13"
                            HeightRequest="38" />

                        <Label
                            Text="{Binding ChangeAuthenticatorPasswordError}"
                            TextColor="#FF7474"
                            FontSize="11"
                            IsVisible="{Binding ChangeAuthenticatorPasswordError, Converter={StaticResource StringNotNullOrWhiteSpaceConverter}}" />
                        <Label
                            Text="{Binding ChangeAuthenticatorPasswordSuccess}"
                            TextColor="#63F5A8"
                            FontSize="11"
                            IsVisible="{Binding ChangeAuthenticatorPasswordSuccess, Converter={StaticResource StringNotNullOrWhiteSpaceConverter}}" />

                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12" VerticalOptions="Center">
                            <Button
                                Text="Authenticator-Passwort aktualisieren"
                                Command="{Binding ChangeAuthenticatorPasswordCommand}"
                                BackgroundColor="#4A5CFF"
                                TextColor="White"
                                FontSize="13"
                                CornerRadius="12"
                                Padding="12,8" />
                            <ActivityIndicator
                                Grid.Column="1"
                                IsRunning="{Binding IsAuthenticatorPasswordChangeBusy}"
                                IsVisible="{Binding IsAuthenticatorPasswordChangeBusy}"
                                Color="#63F5A8"
                                WidthRequest="24"
                                HeightRequest="24" />
                        </Grid>
                    </VerticalStackLayout>
                </Border>
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>